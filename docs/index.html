<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>OpenClaw</title>
  <style>
    :root {
      --bg:#0d1117;
      --card:#161b22;
      --txt:#e6edf3;
      --muted:#8b949e;
      --accent:#2f81f7;
      --ok:#1f9d55;
      --warn:#f59e0b;
      --bad:#ef4444;
    }
    * { box-sizing:border-box; }
    body {
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background: radial-gradient(circle at 20% 0%, #1f2a44 0%, var(--bg) 40%);
      color:var(--txt);
    }
    .wrap { max-width:900px; margin:40px auto; padding:20px; display:grid; gap:14px; }
    .card { background:var(--card); border:1px solid #30363d; border-radius:14px; padding:20px; }
    .row { display:flex; gap:10px; flex-wrap:wrap; margin:10px 0; align-items:center; }
    .col { display:grid; gap:10px; }
    button {
      background:var(--accent);
      color:white;
      border:none;
      border-radius:10px;
      padding:10px 14px;
      cursor:pointer;
      font-weight:600;
    }
    button.secondary { background:#374151; }
    button.warn { background:var(--warn); color:#111827; }
    input, select {
      flex:1;
      min-width:160px;
      padding:10px;
      border-radius:10px;
      border:1px solid #30363d;
      background:#0b0f14;
      color:var(--txt);
    }
    .muted { color:var(--muted); font-size:14px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; word-break:break-all; }
    .grid-2 { display:grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap:10px; }
    .kv { padding:10px; border:1px solid #30363d; border-radius:10px; background:#0b0f14; }
    .kv b { display:block; font-size:12px; color:var(--muted); margin-bottom:4px; }
    .status { min-height:20px; }
    .ok { color:var(--ok); }
    .bad { color:var(--bad); }
    textarea {
      width:100%;
      min-height:120px;
      padding:10px;
      border-radius:10px;
      border:1px solid #30363d;
      background:#0b0f14;
      color:var(--txt);
      resize:vertical;
    }
    .history-list { margin:0; padding-left:18px; display:grid; gap:6px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h2>OpenClaw (OCL)</h2>
      <p class="muted">网络: BSC Testnet (chainId 97)</p>
      <p class="muted">合约: <span class="mono" id="contract"></span></p>
      <div class="row">
        <button id="connect">连接钱包</button>
        <button id="addToken" class="secondary">添加 OCL 到钱包</button>
        <span id="account" class="muted"></span>
      </div>
      <div class="row">
        <button id="balance">查询 OCL 余额</button>
        <span id="balanceOut" class="muted"></span>
      </div>
      <div class="row">
        <b>tBNB 余额:</b>
        <span id="nativeOut" class="muted">-</span>
      </div>
      <div class="row">
        <input id="to" placeholder="收款地址" />
        <input id="amount" placeholder="数量" />
        <button id="send">转账</button>
      </div>
      <div class="col">
        <p class="muted">批量空投: 每行一个 `地址,数量`，示例 `0xabc...,100`</p>
        <textarea id="bulkInput" placeholder="0x123...,10&#10;0x456...,25"></textarea>
        <div class="row">
          <button id="bulkPreview" class="secondary">预览空投</button>
          <button id="bulkSend" class="warn">执行空投</button>
        </div>
      </div>
      <p id="status" class="muted status"></p>
    </div>

    <div class="card">
      <h2>最近转账历史</h2>
      <p class="muted">已分配总额: <span id="historyTotal" class="mono">0 OCL</span></p>
      <div class="row">
        <button id="refreshHistory" class="secondary">刷新历史</button>
        <button id="clearHistory" class="secondary">清空历史</button>
      </div>
      <ul id="historyList" class="history-list muted"></ul>
    </div>

    <div class="card">
      <h2>Hyperliquid 永续 (去中心化)</h2>
      <p class="muted">当前版本: 行情 + 交易入口（下单在 Hyperliquid 官方页面完成）</p>

      <div class="row">
        <select id="hlSymbol"></select>
        <button id="hlRefresh" class="secondary">刷新行情</button>
      </div>

      <div class="grid-2">
        <div class="kv"><b>中间价 Mid</b><span id="hlMid">-</span></div>
        <div class="kv"><b>标记价 Mark</b><span id="hlMark">-</span></div>
        <div class="kv"><b>资金费率 Funding</b><span id="hlFunding">-</span></div>
        <div class="kv"><b>24h 变动</b><span id="hlDay">-</span></div>
      </div>

      <div class="row">
        <select id="hlSide">
          <option value="LONG">LONG</option>
          <option value="SHORT">SHORT</option>
        </select>
        <input id="hlLeverage" type="number" min="1" step="1" value="5" placeholder="杠杆" />
        <input id="hlSize" type="number" min="0" step="0.001" placeholder="名义仓位(USD)" />
      </div>

      <div class="row">
        <button id="hlCheck" class="warn">下单前检查</button>
        <button id="hlTrade">去 Hyperliquid 下单</button>
      </div>
      <p id="hlStatus" class="muted status"></p>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/ethers@6.13.2/dist/ethers.umd.min.js"></script>
  <script src="./config.js"></script>
  <script>
    const abi = [
      'function balanceOf(address) view returns (uint256)',
      'function transfer(address,uint256) returns (bool)'
    ];
    const TOKEN_DECIMALS = 18;
    const REQUIRED_CHAIN_ID = 97n;
    const HISTORY_KEY = 'openclaw_transfer_history_v1';

    const contractEl = document.getElementById('contract');
    contractEl.textContent = window.OPENCLAW_ADDRESS;

    let provider, signer, account;
    let hlUniverse = [];
    let hlCtxs = [];
    let transferHistory = [];
    const hlFallbackSymbols = ['BTC', 'ETH', 'SOL', 'BNB', 'DOGE', 'XRP', 'ARB', 'OP', 'LINK', 'AAVE'];

    function setText(id, val, cls = 'muted') {
      const el = document.getElementById(id);
      el.textContent = val;
      el.className = cls;
    }

    function shortAddr(addr) {
      return `${addr.slice(0, 6)}...${addr.slice(-4)}`;
    }

    async function refreshNativeBalance() {
      if (!provider || !account) return;
      const wei = await provider.getBalance(account);
      setText('nativeOut', `${ethers.formatUnits(wei, 18)} tBNB`, 'mono');
    }

    function loadHistory() {
      try {
        const raw = localStorage.getItem(HISTORY_KEY);
        transferHistory = raw ? JSON.parse(raw) : [];
      } catch (_) {
        transferHistory = [];
      }
    }

    function saveHistory() {
      localStorage.setItem(HISTORY_KEY, JSON.stringify(transferHistory.slice(0, 100)));
    }

    function addHistoryItem(item) {
      transferHistory.unshift(item);
      transferHistory = transferHistory.slice(0, 100);
      saveHistory();
      renderHistory();
    }

    function renderHistory() {
      const ul = document.getElementById('historyList');
      let total = 0;
      ul.innerHTML = '';
      if (!transferHistory.length) {
        const li = document.createElement('li');
        li.textContent = '暂无转账记录';
        ul.appendChild(li);
        setText('historyTotal', '0 OCL', 'mono');
        return;
      }
      for (const r of transferHistory) {
        const li = document.createElement('li');
        const ts = new Date(r.time).toLocaleString();
        li.innerHTML = `<span class=\"mono\">${shortAddr(r.from)} -> ${shortAddr(r.to)}</span> | ${r.amount} OCL | <a class=\"mono\" href=\"https://testnet.bscscan.com/tx/${r.hash}\" target=\"_blank\" rel=\"noopener noreferrer\">${r.hash.slice(0, 10)}...</a> | ${ts}`;
        ul.appendChild(li);
        const n = Number(r.amount || 0);
        if (Number.isFinite(n) && n > 0) total += n;
      }
      setText('historyTotal', `${total} OCL`, 'mono');
    }

    function parseBulkRows(text) {
      // Accept mobile paste variants: Chinese comma/semicolon, one-line multi-items,
      // and hidden whitespace characters copied from chat apps.
      const normalized = String(text || '')
        .replace(/[，]/g, ',')
        .replace(/[；;]/g, '\n')
        .replace(/\r/g, '\n')
        .replace(/[\u200B-\u200D\uFEFF]/g, '')
        .replace(/\s+(?=0x[a-fA-F0-9]{40}\s*,)/g, '\n');
      const rows = normalized.split('\n').map(x => x.trim()).filter(Boolean);
      const parsed = [];
      for (let i = 0; i < rows.length; i++) {
        const line = rows[i];
        const byComma = line.split(',').map(x => x.trim()).filter(Boolean);
        let to = '';
        let amount = '';
        if (byComma.length === 2) {
          to = byComma[0];
          amount = byComma[1];
        } else {
          const bySpace = line.split(/\s+/).map(x => x.trim()).filter(Boolean);
          if (bySpace.length === 2) {
            to = bySpace[0];
            amount = bySpace[1];
          } else {
            throw new Error(`第 ${i + 1} 行格式错误，应为 地址,数量`);
          }
        }
        if (!ethers.isAddress(to)) throw new Error(`第 ${i + 1} 行地址无效`);
        const n = Number(amount);
        if (!Number.isFinite(n) || n <= 0) throw new Error(`第 ${i + 1} 行数量无效`);
        parsed.push({ to: to.toLowerCase(), amount: String(n) });
      }
      if (parsed.length === 0) throw new Error('空投列表为空');
      if (parsed.length > 100) throw new Error('单次最多 100 行，避免超时');
      return parsed;
    }

    async function connect() {
      if (!window.ethereum) throw new Error('未找到 MetaMask，请在钱包内置浏览器打开');
      provider = new ethers.BrowserProvider(window.ethereum, 'any');
      const accs = await provider.send('eth_requestAccounts', []);
      account = accs[0];
      await ensureBscTestnet();
      // Recreate provider/signer after network switch to avoid ethers NETWORK_ERROR.
      provider = new ethers.BrowserProvider(window.ethereum, 'any');
      signer = await provider.getSigner();
      document.getElementById('account').textContent = account;
    }

    function getContract(readonly = false) {
      if (!provider) provider = new ethers.BrowserProvider(window.ethereum);
      return new ethers.Contract(window.OPENCLAW_ADDRESS, abi, readonly ? provider : signer);
    }

    async function ensureBscTestnet() {
      const net = await provider.getNetwork();
      if (net.chainId === REQUIRED_CHAIN_ID) return;
      try {
        await window.ethereum.request({
          method: 'wallet_switchEthereumChain',
          params: [{ chainId: '0x61' }]
        });
      } catch (e) {
        const code = e && (e.code === 4902 || e.code === -32603);
        if (code) {
          try {
            await window.ethereum.request({
              method: 'wallet_addEthereumChain',
              params: [{
                chainId: '0x61',
                chainName: 'BSC Testnet',
                nativeCurrency: { name: 'Test BNB', symbol: 'tBNB', decimals: 18 },
                rpcUrls: ['https://bsc-testnet-rpc.publicnode.com'],
                blockExplorerUrls: ['https://testnet.bscscan.com']
              }]
            });
            return;
          } catch (_) {
            throw new Error('请在钱包确认添加 BSC Testnet 网络');
          }
        }
        throw new Error('请切换到 BSC Testnet (chainId 97) 后重试');
      }
    }

    async function ensureTokenContractReady() {
      if (!provider) provider = new ethers.BrowserProvider(window.ethereum);
      const net = await provider.getNetwork();
      if (net.chainId !== REQUIRED_CHAIN_ID) {
        throw new Error('当前不是 BSC Testnet，请先切换网络');
      }
      const code = await provider.getCode(window.OPENCLAW_ADDRESS);
      if (!code || code === '0x') {
        throw new Error('该网络上未找到 OCL 合约，请确认钱包网络为 BSC Testnet');
      }
    }

    async function fetchHlMeta() {
      const res = await fetch('https://api.hyperliquid.xyz/info', {
        method: 'POST',
        headers: { 'content-type': 'application/json' },
        body: JSON.stringify({ type: 'metaAndAssetCtxs' })
      });
      if (!res.ok) throw new Error('Hyperliquid 行情接口失败');
      const data = await res.json();
      hlUniverse = data[0].universe || [];
      hlCtxs = data[1] || [];
    }

    function fillHlSymbol() {
      const sel = document.getElementById('hlSymbol');
      const keep = sel.value;
      sel.innerHTML = '';
      const top = ['BTC', 'ETH', 'SOL', 'BNB', 'DOGE', 'XRP'];
      const names = hlUniverse.length > 0 ? hlUniverse.map(x => x.name) : hlFallbackSymbols;
      const ordered = [...new Set([...top.filter(x => names.includes(x)), ...names])].slice(0, 120);
      for (const n of ordered) {
        const o = document.createElement('option');
        o.value = n;
        o.textContent = n;
        sel.appendChild(o);
      }
      if (keep && ordered.includes(keep)) sel.value = keep;
    }

    function showHlQuote() {
      const symbol = document.getElementById('hlSymbol').value;
      const idx = hlUniverse.findIndex(x => x.name === symbol);
      if (idx < 0 || !hlCtxs[idx]) {
        setText('hlStatus', '行情接口不可用，已切换手动交易模式', 'muted');
        setText('hlMid', '-', 'mono');
        setText('hlMark', '-', 'mono');
        setText('hlFunding', '-', 'mono');
        setText('hlDay', '-', 'muted');
        return;
      }
      const c = hlCtxs[idx];
      setText('hlMid', c.midPx || '-', 'mono');
      setText('hlMark', c.markPx || '-', 'mono');
      setText('hlFunding', c.funding || '-', 'mono');
      const prev = Number(c.prevDayPx || 0);
      const mid = Number(c.midPx || 0);
      const pct = prev > 0 ? ((mid - prev) / prev) * 100 : 0;
      setText('hlDay', `${pct.toFixed(2)}%`, pct >= 0 ? 'ok' : 'bad');
      setText('hlStatus', `已刷新 ${symbol} 行情`, 'muted');
    }

    function hlTradeUrl(symbol) {
      return `https://app.hyperliquid.xyz/trade/${encodeURIComponent(symbol)}`;
    }

    function checkHlOrder() {
      const symbol = document.getElementById('hlSymbol').value;
      const side = document.getElementById('hlSide').value;
      const lev = Number(document.getElementById('hlLeverage').value || 0);
      const size = Number(document.getElementById('hlSize').value || 0);
      const idx = hlUniverse.findIndex(x => x.name === symbol);
      const maxLev = idx >= 0 ? Number(hlUniverse[idx].maxLeverage || 1) : 20;
      if (!Number.isFinite(lev) || lev < 1) return '杠杆必须 >= 1';
      if (lev > maxLev) return `杠杆超限，${symbol} 最大 ${maxLev}x`;
      if (!Number.isFinite(size) || size <= 0) return '名义仓位必须 > 0';
      return `检查通过: ${symbol} ${side}, ${lev}x, ${size} USD`;
    }

    document.getElementById('connect').onclick = async () => {
      try {
        await connect();
        await refreshNativeBalance();
        setText('status', '钱包已连接', 'ok');
      } catch (e) {
        setText('status', e.message || '连接失败', 'bad');
      }
    };

    document.getElementById('addToken').onclick = async () => {
      try {
        if (!window.ethereum) throw new Error('未找到钱包环境');
        const ok = await window.ethereum.request({
          method: 'wallet_watchAsset',
          params: {
            type: 'ERC20',
            options: {
              address: window.OPENCLAW_ADDRESS,
              symbol: 'OCL',
              decimals: 18
            }
          }
        });
        if (ok) {
          setText('status', '已请求添加 OCL，请在钱包确认', 'ok');
        } else {
          setText('status', '钱包未添加 OCL（用户取消或钱包不支持）', 'bad');
        }
      } catch (e) {
        setText('status', e.message || '添加代币失败', 'bad');
      }
    };

    document.getElementById('balance').onclick = async () => {
      try {
        if (!account) await connect();
        await ensureTokenContractReady();
        const c = getContract(true);
        const b = await c.balanceOf(account);
        setText('balanceOut', `${ethers.formatUnits(b, TOKEN_DECIMALS)} OCL`, 'mono');
        await refreshNativeBalance();
      } catch (e) {
        if ((e && e.code === 'NETWORK_ERROR') || String(e?.message || '').includes('network changed')) {
          try {
            provider = new ethers.BrowserProvider(window.ethereum, 'any');
            if (!account) await connect();
            await ensureTokenContractReady();
            const c = getContract(true);
            const b = await c.balanceOf(account);
            setText('balanceOut', `${ethers.formatUnits(b, TOKEN_DECIMALS)} OCL`, 'mono');
            await refreshNativeBalance();
            setText('status', '已自动重连网络并完成查询', 'ok');
            return;
          } catch (_) {}
        }
        setText('status', e.message || '查询失败', 'bad');
      }
    };

    document.getElementById('send').onclick = async () => {
      try {
        if (!account) await connect();
        await ensureTokenContractReady();
        const to = document.getElementById('to').value.trim();
        const amount = document.getElementById('amount').value.trim();
        if (!ethers.isAddress(to)) throw new Error('收款地址无效');
        if (!(Number(amount) > 0)) throw new Error('数量必须 > 0');
        const c = getContract(false);
        const tx = await c.transfer(to, ethers.parseUnits(amount, TOKEN_DECIMALS));
        setText('status', `交易已提交: ${tx.hash}`, 'muted');
        await tx.wait();
        setText('status', `转账成功: ${tx.hash}`, 'ok');
        addHistoryItem({ from: account, to, amount, hash: tx.hash, time: Date.now() });
      } catch (e) {
        setText('status', e.message || '转账失败', 'bad');
      }
    };

    document.getElementById('bulkPreview').onclick = () => {
      try {
        const parsed = parseBulkRows(document.getElementById('bulkInput').value);
        const total = parsed.reduce((s, x) => s + Number(x.amount), 0);
        setText('status', `空投预览: ${parsed.length} 笔, 合计 ${total} OCL`, 'ok');
      } catch (e) {
        setText('status', e.message || '预览失败', 'bad');
      }
    };

    document.getElementById('bulkSend').onclick = async () => {
      try {
        if (!account) await connect();
        await ensureTokenContractReady();
        const parsed = parseBulkRows(document.getElementById('bulkInput').value);
        setText('status', `开始空投，共 ${parsed.length} 笔...`, 'muted');
        const c = getContract(false);
        for (let i = 0; i < parsed.length; i++) {
          const row = parsed[i];
          setText('status', `发送中 ${i + 1}/${parsed.length}: ${shortAddr(row.to)} ${row.amount} OCL`, 'muted');
          const tx = await c.transfer(row.to, ethers.parseUnits(row.amount, TOKEN_DECIMALS));
          await tx.wait();
          addHistoryItem({ from: account, to: row.to, amount: row.amount, hash: tx.hash, time: Date.now() });
        }
        setText('status', `空投完成，共 ${parsed.length} 笔`, 'ok');
      } catch (e) {
        setText('status', e.message || '空投失败', 'bad');
      }
    };

    document.getElementById('refreshHistory').onclick = () => {
      loadHistory();
      renderHistory();
      setText('status', '已刷新本地历史', 'ok');
    };

    document.getElementById('clearHistory').onclick = () => {
      transferHistory = [];
      saveHistory();
      renderHistory();
      setText('status', '已清空本地历史', 'ok');
    };

    document.getElementById('hlRefresh').onclick = async () => {
      try {
        await fetchHlMeta();
        fillHlSymbol();
        showHlQuote();
      } catch (e) {
        fillHlSymbol();
        showHlQuote();
        setText('hlStatus', '无法连接 Hyperliquid 行情接口，可直接点“去 Hyperliquid 下单”', 'bad');
      }
    };

    document.getElementById('hlSymbol').onchange = () => showHlQuote();

    document.getElementById('hlCheck').onclick = () => {
      const msg = checkHlOrder();
      const ok = msg.startsWith('检查通过');
      setText('hlStatus', msg, ok ? 'ok' : 'bad');
    };

    document.getElementById('hlTrade').onclick = () => {
      const symbol = document.getElementById('hlSymbol').value;
      const msg = checkHlOrder();
      if (!msg.startsWith('检查通过')) {
        setText('hlStatus', msg, 'bad');
        return;
      }
      const url = hlTradeUrl(symbol);
      window.open(url, '_blank', 'noopener,noreferrer');
      setText('hlStatus', `已打开 Hyperliquid: ${symbol}`, 'ok');
    };

    (async () => {
      loadHistory();
      renderHistory();
      try {
        await fetchHlMeta();
        fillHlSymbol();
        showHlQuote();
      } catch (e) {
        fillHlSymbol();
        showHlQuote();
        setText('hlStatus', '无法连接 Hyperliquid 行情接口，已启用手动交易模式', 'bad');
      }
    })();
  </script>
</body>
</html>
